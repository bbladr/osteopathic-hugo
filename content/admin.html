<style>
  #news-title-form {
    margin: 10px;
  }
  #news-body-form {
    margin: 10px;
  }
  #news-upload {
    margin: 10px;
  }
</style>
<body>
  <div class="container">
    <div class="row">
      <div class="col-12">
        <input id="news-title-form" type="text" placeholder="タイトル">
      </div>
      <div class="col-12">
        <textarea id="news-body-form" placeholder="内容" rows="20"></textarea>
      </div>
      <div class="col-12">
        <input type="button" id="news-upload" value="送信">
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        投稿を削除する
      </div>
      <div class="col-12">
        {{ with .Site.GetPage "/news" }}
          {{ range .Pages }}
            <input id="news-delete-list" value={{ .Date }}>
              {{ .Date.Format "2006/01/02" }}
              {{ .Title }}
            </div>
          {{ end }}
      {{ end }}
        </div>
    </div>
  </div>
</body>



{{ "<!-- jquery -->" | safeHTML }}
<script src='{{ "plugins/jQurey/jquery.min.js" | absURL }}'></script>
{{ "<!-- bootstrap js -->" | safeHTML }}
<script src='{{ "plugins/bootstrap/bootstrap.min.js" | absURL }}'></script>

<script>
  $('#news-upload').click(function () {
    // token 入力ダイアログにより token を取得
    const token_id = window.prompt("パスワードを入力してください", "");
    const token = `token ${token_id}`;
    
    $('#news-upload').val("投稿中...");
    $('#news-upload').attr("disabled", "true");

    const now = new Date();
    const year = now.getFullYear();
    const month = toDoubleDigits(now.getMonth() + 1);
    const date = toDoubleDigits(now.getDate());
    const hour = toDoubleDigits(now.getHours());
    const minute = toDoubleDigits(now.getMinutes());
    const second = toDoubleDigits(now.getSeconds());
    const time = `${year}${month}${date}${hour}${minute}${second}`;

    const createAt = `${year}-${month}-${date}T${hour}:${minute}:${second}+09:00`;
    const title = $('#news-title-form').val();
    const body = $('#news-body-form').val();
    const article = generateArticle(title, body, createAt);
    const articleBase64 = btoa(unescape(encodeURIComponent(article)));

    const baseUrl = "https://api.github.com";
    const endPoint = "/repos/bbladr/osteopathic-hugo/contents";
    const filePath = `/content/news/${time}.md`;
    const url = `${baseUrl}${endPoint}${filePath}`;

    $.ajax({
      type: "PUT",
      url: url,
      data: JSON.stringify({
        "message": "Upload a news article",
        "content": articleBase64,
      }),
      headers: {
        "Authorization": token,
        "Content-Type": "application/json",
      },
    }).done(function(data) {
      alert('Newsトピックを投稿しました。反映まで数分かかります。');
      $("#news-title-form").val("");
      $("#news-body-form").val("");
      $('#news-upload').val("送信");
      $('#news-upload').removeAttr("disabled");
    }).fail(function(data) {
      alert('投稿に失敗しました');
    });
  });
</script>
<script>
  const generateArticle = function(title, body, createAt) {
  return `---
title: "${title}"
date: ${createAt}
description : "news"
draft: false
---
${body}`
  }
</script>
<script>
  // 1桁の数字を0埋めで2桁にする
  const toDoubleDigits = function(num) {
    num += "";
    if (num.length === 1) {
      num = "0" + num;
    }
  return num;     
  };
</script>

